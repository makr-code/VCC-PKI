# VCC PKI TSA - HAProxy Load Balancer Configuration
# Production-grade load balancing for TSA services

global
    # Security and performance settings
    daemon
    user haproxy
    group haproxy
    chroot /var/lib/haproxy
    
    # SSL settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    # Performance tuning
    tune.ssl.default-dh-param 2048
    tune.ssl.capture-cipherlist-size 4
    tune.maxrewrite 1024
    maxconn 4096
    
    # Stats socket for management
    stats socket /var/lib/haproxy/stats mode 660

defaults
    mode http
    timeout connect 5s
    timeout client 30s
    timeout server 30s
    timeout http-request 10s
    timeout http-keep-alive 2s
    timeout queue 30s
    
    # Error handling
    errorfile 400 /etc/haproxy/errors/400.http
    errorfile 403 /etc/haproxy/errors/403.http
    errorfile 408 /etc/haproxy/errors/408.http
    errorfile 500 /etc/haproxy/errors/500.http
    errorfile 502 /etc/haproxy/errors/502.http
    errorfile 503 /etc/haproxy/errors/503.http
    errorfile 504 /etc/haproxy/errors/504.http
    
    # Logging
    option httplog
    option dontlognull
    option log-health-checks
    
    # Connection management
    option http-server-close
    option redispatch
    retries 3

# Statistics interface
listen stats
    bind :8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats admin if TRUE
    stats auth admin:VCC-TSA-Stats-2024
    stats show-legends
    stats show-node

# HTTP to HTTPS redirect
frontend http_frontend
    bind :80
    redirect scheme https code 301 if !{ ssl_fc }

# Main HTTPS frontend for TSA
frontend https_frontend
    bind :443 ssl crt /etc/ssl/certs/vcc-tsa.pem alpn h2,http/1.1
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy "strict-origin-when-cross-origin"
    
    # Rate limiting by IP
    stick-table type ip size 100k expire 30s store http_req_rate(10s)
    http-request track-sc0 src
    http-request deny if { sc_http_req_rate(0) gt 100 }
    
    # TSA API routing
    acl is_tsa_api path_beg /api/v1/tsa
    acl is_health_check path_beg /health
    acl is_metrics path_beg /metrics
    
    # Route to appropriate backend
    use_backend tsa_api_backend if is_tsa_api
    use_backend tsa_health_backend if is_health_check
    use_backend tsa_metrics_backend if is_metrics
    
    # Default to main TSA service
    default_backend tsa_main_backend

# TSA API Backend (main service endpoints)
backend tsa_api_backend
    mode http
    balance roundrobin
    
    # Health checks
    option httpchk GET /health HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    http-check expect status 200
    
    # Connection settings
    option http-server-close
    option forwardfor
    option httplog
    
    # Stick table for session persistence (if needed)
    stick-table type string len 32 size 30k expire 30m
    stick on cookie(JSESSIONID)
    
    # Server definitions
    server tsa-1 vcc-tsa-1:8080 check inter 10s fall 3 rise 2 maxconn 500
    server tsa-2 vcc-tsa-2:8080 check inter 10s fall 3 rise 2 maxconn 500
    server tsa-3 vcc-tsa-3:8080 check inter 10s fall 3 rise 2 maxconn 500
    
    # Emergency backup server (read-only mode)
    server tsa-backup vcc-tsa-backup:8080 check inter 30s fall 5 rise 3 backup

# Health Check Backend
backend tsa_health_backend
    mode http
    balance roundrobin
    
    # Quick health checks
    option httpchk GET /health/quick HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    http-check expect status 200
    
    server tsa-health-1 vcc-tsa-1:8080 check inter 5s
    server tsa-health-2 vcc-tsa-2:8080 check inter 5s
    server tsa-health-3 vcc-tsa-3:8080 check inter 5s

# Metrics Backend (Prometheus metrics)
backend tsa_metrics_backend
    mode http
    balance roundrobin
    
    # No health check needed for metrics
    option httpchk GET /metrics HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    
    server tsa-metrics-1 vcc-tsa-1:8080 check inter 30s
    server tsa-metrics-2 vcc-tsa-2:8080 check inter 30s
    server tsa-metrics-3 vcc-tsa-3:8080 check inter 30s

# Main TSA Backend (catch-all)
backend tsa_main_backend
    mode http
    balance leastconn
    
    # Health checks
    option httpchk GET /health HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    http-check expect status 200
    
    # Connection settings
    option http-server-close
    option forwardfor
    
    # Server definitions with weights
    server tsa-main-1 vcc-tsa-1:8080 check inter 10s weight 100
    server tsa-main-2 vcc-tsa-2:8080 check inter 10s weight 100
    server tsa-main-3 vcc-tsa-3:8080 check inter 10s weight 50

# Clara AI Model Backend (specific VCC service)
backend clara_backend
    mode http
    balance source
    
    # Clara-specific health check
    option httpchk GET /api/v1/tsa/clara/health HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    http-check expect status 200
    
    # Dedicated Clara servers for model timestamping
    server clara-tsa-1 vcc-tsa-clara-1:8080 check inter 15s
    server clara-tsa-2 vcc-tsa-clara-2:8080 check inter 15s

# Covina Workflow Backend
backend covina_backend
    mode http
    balance roundrobin
    
    # Covina-specific health check
    option httpchk GET /api/v1/tsa/covina/health HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    
    server covina-tsa-1 vcc-tsa-1:8080 check inter 15s
    server covina-tsa-2 vcc-tsa-2:8080 check inter 15s

# Argus Legal Backend
backend argus_backend
    mode http
    balance roundrobin
    
    # Argus-specific health check with higher timeout for legal compliance
    option httpchk GET /api/v1/tsa/argus/health HTTP/1.1\r\nHost:\ tsa.vcc.brandenburg.de
    http-check expect status 200
    timeout server 60s  # Longer timeout for legal processes
    
    server argus-tsa-1 vcc-tsa-1:8080 check inter 20s
    server argus-tsa-2 vcc-tsa-2:8080 check inter 20s

# Advanced routing for VCC services
frontend vcc_services_frontend
    bind :8443 ssl crt /etc/ssl/certs/vcc-services.pem
    
    # VCC service-specific routing
    acl is_clara path_beg /api/v1/tsa/clara
    acl is_covina path_beg /api/v1/tsa/covina
    acl is_argus path_beg /api/v1/tsa/argus
    acl is_veritas path_beg /api/v1/tsa/veritas
    acl is_vpb path_beg /api/v1/tsa/vpb
    
    # Route to service-specific backends
    use_backend clara_backend if is_clara
    use_backend covina_backend if is_covina
    use_backend argus_backend if is_argus
    use_backend tsa_api_backend if is_veritas
    use_backend tsa_api_backend if is_vpb
    
    # Fallback to main backend
    default_backend tsa_main_backend

# Maintenance page backend
backend maintenance_backend
    mode http
    errorfile 503 /etc/haproxy/errors/maintenance.http

# Emergency configuration for maintenance mode
# Uncomment the following lines to enable maintenance mode:
# frontend maintenance_frontend
#     bind :80
#     bind :443 ssl crt /etc/ssl/certs/vcc-tsa.pem
#     default_backend maintenance_backend